---
title: "Kubernetesã‚’æ¢ã‚‹"
date: 2022-07-22 16:46:00 +0900
tags: [kubernetes, minikube, devops]
categories: [DevOps]
authors: haril
description: "ã“ã®è¨˜äº‹ã§ã¯ã€Kubernetesã®åŸºæœ¬ã¨Docker Desktopã‚’ä½¿ã£ãŸåˆ©ç”¨æ–¹æ³•ã«ã¤ã„ã¦æ¢ã‚Šã¾ã™ã€‚"
---

## Kubernetesã¨ã¯ï¼Ÿ

Kubernetesã¯ä»¥ä¸‹ã®æ©Ÿèƒ½ã‚’æä¾›ã—ã¾ã™ï¼š

- ã‚µãƒ¼ãƒ“ã‚¹ãƒ‡ã‚£ã‚¹ã‚«ãƒãƒªã¨ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚·ãƒ³ã‚°
- ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
- è‡ªå‹•ãƒ­ãƒ¼ãƒ«ã‚¢ã‚¦ãƒˆã¨ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
- è‡ªå‹•ãƒ“ãƒ³ãƒ‘ãƒƒã‚­ãƒ³ã‚°
- è‡ªå‹•ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°
- ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã¨è¨­å®šç®¡ç†

è©³ç´°ã«ã¤ã„ã¦ã¯å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

- [Kubernetes](https://kubernetes.io/ko/docs/concepts/overview/what-is-kubernetes/)

Kubernetesã‚’å®Ÿè¡Œã™ã‚‹æ–¹æ³•ã¯ã„ãã¤ã‹ã‚ã‚Šã¾ã™ãŒã€å…¬å¼ã‚µã‚¤ãƒˆã§ã¯ãƒ‡ãƒ¢ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã«minikubeã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚ã“ã®è¨˜äº‹ã§ã¯ã€Docker Desktopã‚’ä½¿ã£ãŸKubernetesã®åˆ©ç”¨ã«ç„¦ç‚¹ã‚’å½“ã¦ã¾ã™ã€‚minikubeã®ä½¿ã„æ–¹ã‚’å­¦ã³ãŸã„å ´åˆã¯ã€å…¬å¼ã‚µã‚¤ãƒˆã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

ã§ã¯ã€minikubeã«ã¤ã„ã¦ç°¡å˜ã«è§¦ã‚Œã¦ã¿ã¾ã—ã‚‡ã†ã€‚

## Minikube

### ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```bash
brew install minikube
```

### ä½¿ç”¨æ–¹æ³•

ã‚³ãƒãƒ³ãƒ‰ã¯ç›´æ„Ÿçš„ã§ã‚·ãƒ³ãƒ—ãƒ«ãªã®ã§ã€èª¬æ˜ã¯ã»ã¨ã‚“ã©ä¸è¦ã§ã™ã€‚

```bash
minikube start
```

```bash
minikube dashboard
```

```bash
minikube stop
```

```bash
# ä½¿ç”¨å¾Œã®ãƒªã‚½ãƒ¼ã‚¹ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
minikube delete --all
```

### åˆ©ç‚¹

minikubeã¯ã€ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã®è¨­å®šãªã©ã®è©³ç´°ãªè¨­å®šãŒä¸è¦ãªãŸã‚ã€é–‹ç™ºç›®çš„ã«é©ã—ã¦ã„ã¾ã™ã€‚

### æ¬ ç‚¹

ä¸€ã¤ã®å¤§ããªæ¬ ç‚¹ã¯ã€ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’è¡¨ç¤ºã™ã‚‹ã‚³ãƒãƒ³ãƒ‰ãŒãƒãƒ³ã‚°ã‚¢ãƒƒãƒ—ã™ã‚‹ã“ã¨ãŒã‚ã‚‹ç‚¹ã§ã™ã€‚ã“ã®å•é¡ŒãŒä¸»ãªç†ç”±ã§ã€ã“ã®è¨˜äº‹ã‚’æ›¸ãéš›ã«ã¯minikubeã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã›ã‚“ã€‚

## Docker Desktop

### ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

Docker Desktopã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰Kubernetesã‚’æœ‰åŠ¹ã«ã™ã‚‹ã ã‘ã§ã™ã€‚

![enable](./enable-kube.webp)

### ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰

Kubernetesãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯æœ‰åŠ¹ã«ãªã£ã¦ã„ã¾ã›ã‚“ã€‚ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§æœ‰åŠ¹ã«ã§ãã¾ã™ï¼š

```bash
kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v2.5.0/aio/deploy/recommended.yaml
```

#### ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®èµ·å‹•

```bash
kubectl proxy
```

ã“ã®[ãƒªãƒ³ã‚¯](http://localhost:8001/api/v1/namespaces/kubernetes-dashboard/services/https:kubernetes-dashboard:/proxy/)ã‹ã‚‰ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚

![dashboard](./dashboard-login.webp)

ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ã«ã¯ãƒˆãƒ¼ã‚¯ãƒ³ãŒå¿…è¦ã§ã™ã€‚ãƒˆãƒ¼ã‚¯ãƒ³ã®ä½œæˆæ–¹æ³•ã‚’è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

### ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ

ã¾ãšã€é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åˆ¥ã€…ã«ä¿å­˜ã™ã‚‹ãŸã‚ã«`kubernetes`ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆã—ã¾ã™ã€‚

```bash
mkdir kubernetes && cd kubernetes
```

:::warning

ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ç®¡ç†è€…æ¨©é™ã‚’ä»˜ä¸ã™ã‚‹ã“ã¨ã¯ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯ã‚’ä¼´ã†ãŸã‚ã€å®Ÿéš›ã®é‹ç”¨ã§ä½¿ç”¨ã™ã‚‹éš›ã«ã¯æ³¨æ„ãŒå¿…è¦ã§ã™ã€‚

#### dashboard-adminuser.yaml

```yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: admin-user
  namespace: kubernetes-dashboard
```

```bash
kubectl apply -f dashboard-adminuser.yaml
```

#### cluster-role-binding.yml

```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: admin-user
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cluster-admin
subjects:
- kind: ServiceAccount
  name: admin-user
  namespace: kubernetes-dashboard
```

```bash
kubectl apply -f cluster-role-binding.yaml
```

#### ãƒˆãƒ¼ã‚¯ãƒ³ã®ä½œæˆ

```bash
kubectl -n kubernetes-dashboard create token admin-user
```

```text
eyJhbGciOiJSUzI1NiIsImtpZCI6IjVjQjhWQVdpeWdLTlJYeXVKSUpxZndQUkoxdzU3eXFvM2dtMHJQZGY4TUkifQ.eyJhdWQiOlsiaHR0cHM6Ly9rdWJlcm5ldGVzLmRlZmF1bHQuc3ZjLmNsdXN0ZXIubG9jYWwiXSwiZXhwIjox7jU4NTA3NTY1LCJpYXQiOjE2NTg1MDM5NjUsImlzcyI6Imh0dHBzOi8va3ViZXJuZXRlcy5kZWZhdWx0LnN2Yy5jbHVzdGVyLmxvY2FsIiwia3ViZXJuZXRlcy5pbyI6eyJuYW4lc3BhY2UiOiJrdWJlcm5ldGVzLWRhc2hib2FyZCIsInNlcnZpY2VhY2NvdW55Ijp7Im5hbWUiOiJhZG1pbi11c2VyIiwidWlkIjoiZTRkODM5NjQtZWE2MC00ZWI0LTk1NDgtZjFjNWQ3YWM4ZGQ3In19LCJuYmYiOjE2NTg1MDM5NjUsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDprdWJlcm5ldGVzLWRhc2hib2FyZDphZG1pbi11c2VyIn1.RjoUaQnhTVKvzpAx_rToItI8HTZsr-6brMHWL63ca1_D4QIMCxU-zz7HFK04tCvOwyOTWw603XPDCv-ovjs1lM6A3tdgncqs8z1oTRamM4E-Sum8oi7cKnmVFSLjfLKqQxapBvZF5x-SxJ8Myla-izQxYkCtbWIlc6JfShxCSBJvfwSGW8c6kKdYdJv1QQdU1BfPY1sVz__cLNPA70_OpoosHevfVV86hsMvxCwVkNQHIpGlBX-NPog4nLY4gfuCMxKqjdVh8wLT7yS-E3sUJiXCcPJ2-BFSen4y-RIDbg18qbCtE3hQBr033Mfuly1Wc12UkU4bQeiF5SerODDn-g
```

ç”Ÿæˆã•ã‚ŒãŸãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ç”¨ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã™ã€‚

![welcome-view](./welcome.webp)
_ã‚¢ã‚¯ã‚»ã‚¹æˆåŠŸï¼_

### ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã®ä½œæˆ

ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½¿ç”¨ã—ã¦ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚ã“ã®è¨˜äº‹ã§ã¯ã€äº‹å‰ã«æº–å‚™ã•ã‚ŒãŸgolangã‚’ä½¿ç”¨ã—ãŸã‚¦ã‚§ãƒ–ã‚µãƒ¼ãƒãƒ¼ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

```bash
kubectl create deployment rest-server --image=songkg7/rest-server
```

ã‚³ãƒãƒ³ãƒ‰ãŒæ­£å¸¸ã«å®Ÿè¡Œã•ã‚Œã‚‹ã¨ã€ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ã®å¤‰æ›´ã‚’ç°¡å˜ã«ç›£è¦–ã§ãã¾ã™ã€‚

![create-deployment](./create-deployment.webp)
_ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆä½œæˆå¾Œã€ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãŒå³åº§ã«æ›´æ–°ã•ã‚Œã¾ã™ã€‚_

ã—ã‹ã—ã€CLIã‚’ä½¿ç”¨ã—ã¦ã“ã‚Œã‚’ç¢ºèªã™ã‚‹æ–¹æ³•ã‚‚å­¦ã³ã¾ã—ã‚‡ã†ï¼ˆæ ¹æœ¬çš„ãªæ–¹æ³•ã§ã™...ï¼ï¼‰ã€‚

#### ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®ç¢ºèª

```bash
kubectl get deployments
```

![get-deployment](./get-deployment.webp)

ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆãŒä½œæˆã•ã‚Œã‚‹ã¨ã€ãƒãƒƒãƒ‰ã‚‚åŒæ™‚ã«ç”Ÿæˆã•ã‚Œã¾ã™ã€‚

```bash
kubectl get pods -o wide
```

![get-pods](./get-pods.webp)

ã™ã¹ã¦ãŒæ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ãŸã‚‰ã€ã‚¦ã‚§ãƒ–ã‚µãƒ¼ãƒãƒ¼ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚`curl`ã®ä»£ã‚ã‚Šã«`httpie`[^footnote]ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚`curl`ã«æ…£ã‚Œã¦ã„ã‚‹å ´åˆã¯ã€ãã‚Œã‚’ä½¿ç”¨ã—ã¦ã‚‚æ§‹ã„ã¾ã›ã‚“ã€‚

```bash
http localhost:8080/ping
```

![error](./http-error.webp)

ã™ã¹ã¦ãŒæ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã‚‹ã‚ˆã†ã«è¦‹ãˆã‚‹ã®ã«ã€ãªãœå¿œç­”ã‚’å—ã‘å–ã‚Œãªã„ã®ã§ã—ã‚‡ã†ã‹ï¼Ÿ ğŸ¤”

ã“ã‚Œã¯ã€ã‚µãƒ¼ãƒ“ã‚¹ãŒã¾ã å¤–éƒ¨ã«å…¬é–‹ã•ã‚Œã¦ã„ãªã„ãŸã‚ã§ã™ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ã€Kubernetesã®ãƒãƒƒãƒ‰ã¯å†…éƒ¨ã§ã®ã¿é€šä¿¡ã§ãã¾ã™ã€‚ã‚µãƒ¼ãƒ“ã‚¹ã‚’å¤–éƒ¨ã«å…¬é–‹ã—ã¾ã—ã‚‡ã†ã€‚

### ã‚µãƒ¼ãƒ“ã‚¹ã®å…¬é–‹

```bash
kubectl expose deployment rest-server --type=LoadBalancer --port=8080
```

ã‚µãƒ¼ãƒ“ã‚¹ãŒãƒãƒ¼ãƒˆ8080ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ãŸã‚ã€ã“ã®ãƒãƒ¼ãƒˆã‚’é–‹ãã¾ã™ã€‚ç•°ãªã‚‹ãƒãƒ¼ãƒˆã‚’ä½¿ç”¨ã™ã‚‹ã¨æ¥ç¶šã«å•é¡ŒãŒç”Ÿã˜ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

ã§ã¯ã€å†åº¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

```bash
http localhost:8080/ping
```

![200](./rest-server-200.webp)

æˆåŠŸã—ãŸå¿œç­”ã‚’å—ã‘å–ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

### å‚è€ƒè³‡æ–™

- [Web UI ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰](https://kubernetes.io/ko/docs/tasks/access-application-cluster/web-ui-dashboard/)

---

[^footnote]: [Elegant httpie](https://haril.dev/jp/blog/2022/06/25/httpie)
